<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Reversi Room</title>
</head>
<body>
  <h1>Reversi Room</h1>

  <!-- Reset -->
  <div>
    <button onclick="resetRoom()">Reset</button>
    <span>GET /1/reset</span>
  </div>

  <hr>

  <!-- 共通エリア -->
  <div id="responseArea">Response: </div>
  <div id="blackTokenArea">Black Token: </div>
  <div id="whiteTokenArea">White Token: </div>
  <div id="observerTokenArea">Observer Token: </div>

  <hr>

  <!-- Black (GET) -->
  <h2>Black (GET)</h2>
  <div>
    <button onclick="joinGet('black')">Join</button>
    <span>/1/join?seat=black</span>
  </div>
  <div>
    <label>X:</label>
    <select id="blackX"></select>
    <label>Y:</label>
    <select id="blackY"></select>
    <button onclick="moveGet()">Move</button>
    <span>/1/move?token=&lt;blackToken&gt;&x=&lt;x&gt;&y=&lt;y&gt;</span>
  </div>
  <div>
    <button onclick="leaveGet()">Leave</button>
    <span>/1/leave?token=&lt;blackToken&gt;</span>
  </div>
  <div>
    <button onclick="startHeartbeat('black')">Heartbeat Start</button>
    <button onclick="stopHeartbeat('black')">Heartbeat Stop</button>
  </div>

  <hr>

  <!-- White (POST) -->
  <h2>White (POST)</h2>
  <div>
    <button onclick="joinPost('white')">Join</button>
    <span>POST /1/join body: { seat:"white" }</span>
  </div>
  <div>
    <label>X:</label>
    <select id="whiteX"></select>
    <label>Y:</label>
    <select id="whiteY"></select>
    <button onclick="movePost()">Move</button>
    <span>POST /1/move body: { token:"&lt;whiteToken&gt;", x:&lt;x&gt;, y:&lt;y&gt; }</span>
  </div>
  <div>
    <button onclick="leavePost()">Leave</button>
    <span>POST /1/leave body: { token:"&lt;whiteToken&gt;" }</span>
  </div>
  <div>
    <button onclick="startHeartbeat('white')">Heartbeat Start</button>
    <button onclick="stopHeartbeat('white')">Heartbeat Stop</button>
  </div>

  <hr>

  <!-- Observer (POST) -->
  <h2>Observer (POST)</h2>
  <div>
    <button onclick="joinPost('observer')">Join</button>
    <span>POST /1/join body: { seat:"observer" }</span>
  </div>
  <div>
    <button onclick="leavePost()">Leave</button>
    <span>POST /1/leave body: { token:"&lt;observerToken&gt;" }</span>
  </div>
  <div>
    <button onclick="startHeartbeat('observer')">Heartbeat Start</button>
    <button onclick="stopHeartbeat('observer')">Heartbeat Stop</button>
  </div>

  <hr>

  <!-- SSE -->
  <h2>SSE</h2>
  <div id="sseInit">init: </div>
  <div id="sseJoin">join: </div>
  <div id="sseMove">move: </div>
  <div id="sseLeave">leave: </div>
  <div id="sseReset">reset: </div>

  <script>
    const id = "1"; // 今は固定で Room 1

    let blackToken = null;
    let whiteToken = null;
    let observerToken = null;

    let blackHbTimer = null;
    let whiteHbTimer = null;
    let observerHbTimer = null;

    async function handleResponse(res) {
      let rawText = "";
      let parsed = null;

      try {
        parsed = await res.json();
        rawText = JSON.stringify(parsed);
      } catch {
        rawText = await res.text();
      }

      document.getElementById("responseArea").innerText =
        "Response: " + rawText + " (status " + res.status + ")";

      if (parsed && parsed.token && parsed.role) {
        if (parsed.role === "black") {
          blackToken = parsed.token;
          document.getElementById("blackTokenArea").innerText =
            "Black Token: " + blackToken;
        } else if (parsed.role === "white") {
          whiteToken = parsed.token;
          document.getElementById("whiteTokenArea").innerText =
            "White Token: " + whiteToken;
        } else if (parsed.role === "observer") {
          observerToken = parsed.token;
          document.getElementById("observerTokenArea").innerText =
            "Observer Token: " + observerToken;
        }
      }
    }

    // --- Reset (GET) ---
    async function resetRoom() {
      const endpoint = `/${id}/reset`;
      const res = await fetch(endpoint);
      await handleResponse(res);
      blackToken = whiteToken = observerToken = null;
      document.getElementById("blackTokenArea").innerText = "Black Token: ";
      document.getElementById("whiteTokenArea").innerText = "White Token: ";
      document.getElementById("observerTokenArea").innerText = "Observer Token: ";
    }

    // Heartbeat control
    function startHeartbeat(role) {
      const token = role === "black" ? blackToken : role === "white" ? whiteToken : observerToken;
      if (!token) return alert(`${role} token missing`);

      const body = { token };
      const sendHb = async () => {
        await fetch(`/${id}/hb`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
      };

      if (role === "black" && !blackHbTimer) {
        blackHbTimer = setInterval(sendHb, 5000);
      } else if (role === "white" && !whiteHbTimer) {
        whiteHbTimer = setInterval(sendHb, 5000);
      } else if (role === "observer" && !observerHbTimer) {
        observerHbTimer = setInterval(sendHb, 5000);
      }
    }

    function stopHeartbeat(role) {
      if (role === "black" && blackHbTimer) {
        clearInterval(blackHbTimer); blackHbTimer = null;
      } else if (role === "white" && whiteHbTimer) {
        clearInterval(whiteHbTimer); whiteHbTimer = null;
      } else if (role === "observer" && observerHbTimer) {
        clearInterval(observerHbTimer); observerHbTimer = null;
      }
    }

    // ... (joinGet, moveGet, joinPost など既存の関数は省略) ...

    // SSE 接続
    const es = new EventSource(`/${id}/sse`);
    es.addEventListener("init", (e) => { document.getElementById("sseInit").innerText = "init: " + e.data; });
    es.addEventListener("join", (e) => { document.getElementById("sseJoin").innerText = "join: " + e.data; });
    es.addEventListener("move", (e) => { document.getElementById("sseMove").innerText = "move: " + e.data; });
    es.addEventListener("leave", (e) => { document.getElementById("sseLeave").innerText = "leave: " + e.data; });
    es.addEventListener("reset", (e) => { document.getElementById("sseReset").innerText = "reset: " + e.data; });
  </script>
</body>
</html>