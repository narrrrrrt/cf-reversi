<script>
  const params = new URLSearchParams(window.location.search);
  const roomId = params.get("id");
  const seat   = params.get("seat");

  let token = null;

  // 初期URL表示（直下形式に修正）
  document.getElementById("joinPost").textContent = `POST /${roomId}/join (body seat=${seat})`;
  document.getElementById("joinGet").textContent  = `GET  /${roomId}/join?seat=${seat}`;

  document.getElementById("movePost").textContent = `POST /${roomId}/move (body {x,y})`;
  document.getElementById("moveGet").textContent  = `GET  /${roomId}/move?x=3&y=4`;

  document.getElementById("leavePost").textContent = `POST /${roomId}/leave (body token=...)`;
  document.getElementById("leaveGet").textContent  = `GET  /${roomId}/leave?token=...`;

  document.getElementById("sseUrl").textContent   = `GET  /${roomId}/sse`;

  async function join() {
    const res = await fetch(`/${roomId}/join`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ seat })
    });
    const data = await res.json();
    document.getElementById("status").textContent = "Joined as " + seat;
    if (data.token) {
      token = data.token;
      document.getElementById("token").textContent = "Token: " + token;
      document.getElementById("leavePost").textContent =
        `POST /${roomId}/leave (body token=${token})`;
      document.getElementById("leaveGet").textContent =
        `GET  /${roomId}/leave?token=${token}`;
    }
  }

  async function move(x, y) {
    const res = await fetch(`/${roomId}/move`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ x, y })
    });
    const data = await res.json();
    console.log("Move:", data);
  }

  async function leave() {
    if (!token) {
      alert("No token available. Join first.");
      return;
    }
    const res = await fetch(`/${roomId}/leave`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token })
    });
    const data = await res.json();
    document.getElementById("status").textContent = "Left room";
    document.getElementById("token").textContent = "Token: (released)";
  }

  function connectSSE() {
    const url = `/${roomId}/sse`;
    const eventSource = new EventSource(url);
    eventSource.onmessage = (e) => {
      console.log("SSE:", e.data);
    };
  }
</script>