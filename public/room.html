<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reversi Room</title>
  <style>
    .action-row { margin: 8px 0; }
    .url { margin-left: 10px; color: gray; font-family: monospace; font-size: 0.9em; display:block; }
    #sseOutput { margin-top: 1em; padding: 0.5em; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h1>Reversi Room</h1>
  <div id="status">Not joined yet</div>
  <div id="token">Token: (not issued)</div>

  <div id="controls"></div>
  <div id="sseOutput"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("id");
    const mode   = params.get("mode"); // "play" or "observer"
    let token = null;

    const controls = document.getElementById("controls");

    // --- SSE ---
    function connectSSE() {
      const output = document.getElementById("sseOutput");
      output.innerHTML = "<b>SSE connected...</b><br>";

      const es = new EventSource(`/${roomId}/sse`);
      es.onmessage = (e) => {
        const msg = document.createElement("div");
        msg.textContent = e.data;
        output.appendChild(msg);
      };
      es.onerror = () => {
        const msg = document.createElement("div");
        msg.style.color = "red";
        msg.textContent = "[SSE error]";
        output.appendChild(msg);
        es.close();
      };
    }

    // --- Play Mode (Black/White) ---
    async function joinWhite() {
      const res = await fetch(`/${roomId}/join`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ seat: "white" })
      });
      const data = await res.json();
      if (data.token) {
        token = data.token;
        document.getElementById("token").innerHTML = "White Token: " + token;
      }
    }

    async function joinBlack() {
      const res = await fetch(`/${roomId}/join?seat=black`);
      const data = await res.json();
      if (data.token) {
        token = data.token;
        document.getElementById("token").innerHTML = "Black Token: " + token;
      }
    }

    async function movePost() {
      if (!token) { alert("No token"); return; }
      const res = await fetch(`/${roomId}/move`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ x: 3, y: 4, token })
      });
      const data = await res.json();
      document.getElementById("token").innerHTML = JSON.stringify(data);
    }

    async function moveGet() {
      if (!token) { alert("No token"); return; }
      const res = await fetch(`/${roomId}/move?x=3&y=4&token=${token}`);
      const data = await res.json();
      document.getElementById("token").innerHTML = JSON.stringify(data);
    }

    async function leavePost() {
      if (!token) { alert("No token"); return; }
      const res = await fetch(`/${roomId}/leave`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      document.getElementById("token").innerHTML = JSON.stringify(data);
    }

    async function leaveGet() {
      if (!token) { alert("No token"); return; }
      const res = await fetch(`/${roomId}/leave?token=${token}`);
      const data = await res.json();
      document.getElementById("token").innerHTML = JSON.stringify(data);
    }

    // --- Observer Mode ---
    async function joinObserver() {
      const res = await fetch(`/${roomId}/join`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ seat: "observer" })
      });
      const data = await res.json();
      if (data.token) {
        token = data.token;
        document.getElementById("token").innerHTML = "Observer Token: " + token;
      }
    }

    async function leaveObserver() {
      if (!token) { alert("No token"); return; }
      const res = await fetch(`/${roomId}/leave?token=${token}`);
      const data = await res.json();
      document.getElementById("token").innerHTML = JSON.stringify(data);
    }

    // --- Render buttons depending on mode ---
    if (mode === "play") {
      controls.innerHTML = `
        <div class="action-row"><button onclick="joinWhite()">Join White (POST)</button></div>
        <div class="action-row"><button onclick="joinBlack()">Join Black (GET)</button></div>
        <div class="action-row"><button onclick="movePost()">Move (POST)</button></div>
        <div class="action-row"><button onclick="moveGet()">Move (GET)</button></div>
        <div class="action-row"><button onclick="leavePost()">Leave (POST)</button></div>
        <div class="action-row"><button onclick="leaveGet()">Leave (GET)</button></div>
        <div class="action-row"><button onclick="connectSSE()">Connect SSE</button></div>
      `;
    } else if (mode === "observer") {
      controls.innerHTML = `
        <div class="action-row"><button onclick="joinObserver()">Join as Observer (POST)</button></div>
        <div class="action-row"><button onclick="leaveObserver()">Leave as Observer (GET)</button></div>
        <div class="action-row"><button onclick="connectSSE()">Connect SSE</button></div>
      `;
    }
  </script>
</body>
</html>